generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String                @id @default(cuid())
  email                  String                @unique
  passwordHash           String
  emailVerified          DateTime?
  firstName              String
  lastName               String
  middleName             String?
  organization           String?
  position               String?
  phone                  String?
  photo                  String?
  role                   UserRole              @default(PARTICIPANT)
  agreedToTerms          Boolean               @default(false)
  agreedToDataProcessing Boolean               @default(false)
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
  applications           Application[]
  expertAssignments      ExpertAssignment[]
  protocolAssignments    ProtocolAssignment[]
  protocolSignatures     ProtocolSignature[]
  scores                 Score[]
  skillPassports         SkillPassport[]
  uploadedFiles          TeamFile[]
  teamMemberships        TeamMember[]

  @@map("users")
}

model Event {
  id                String            @id @default(cuid())
  name              String
  description       String?
  competency        String
  logo              String?
  registrationStart DateTime
  registrationEnd   DateTime
  eventStart        DateTime
  eventEnd          DateTime
  status            EventStatus       @default(DRAFT)
  maxTeamSize       Int               @default(4)
  minTeamSize       Int               @default(1)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  applications      Application[]
  assessmentSchema  AssessmentSchema?
  documents         EventDocument[]
  protocols         Protocol[]
  skillPassports    SkillPassport[]
  teams             Team[]

  @@map("events")
}

model EventDocument {
  id        String         @id @default(cuid())
  eventId   String
  name      String
  type      DocumentType
  access    DocumentAccess @default(PARTICIPANTS)
  fileUrl   String
  version   Int            @default(1)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  event     Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("event_documents")
}

model Application {
  id                 String            @id @default(cuid())
  userId             String
  eventId            String
  status             ApplicationStatus @default(PENDING)
  agreedToRegulation Boolean           @default(false)
  comment            String?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  event              Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user               User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("applications")
}

model Team {
  id             String          @id @default(cuid())
  eventId        String
  name           String
  number         Int?
  rank           Int?
  totalScore     Float?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  scores         Score[]
  skillPassports SkillPassport[]
  files          TeamFile[]
  members        TeamMember[]
  event          Event           @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@unique([eventId, name])
  @@map("teams")
}

model TeamMember {
  id        String         @id @default(cuid())
  teamId    String
  userId    String
  role      TeamMemberRole @default(MEMBER)
  createdAt DateTime       @default(now())
  team      Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

model TeamFile {
  id           String   @id @default(cuid())
  teamId       String
  uploadedById String
  moduleCode   String
  fileName     String
  fileUrl      String
  fileSize     Int
  createdAt    DateTime @default(now())
  team         Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation(fields: [uploadedById], references: [id])

  @@map("team_files")
}

model AssessmentSchema {
  id            String             @id @default(cuid())
  eventId       String             @unique
  name          String
  totalMaxScore Float              @default(100)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  modules       AssessmentModule[]
  event         Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)
  skillGroups   SkillGroup[]

  @@map("assessment_schemas")
}

model AssessmentModule {
  id          String           @id @default(cuid())
  schemaId    String
  code        String
  name        String
  nameEn      String?
  maxScore    Float
  order       Int              @default(0)
  schema      AssessmentSchema @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  subCriteria SubCriterion[]

  @@unique([schemaId, code])
  @@map("assessment_modules")
}

model SkillGroup {
  id       String           @id @default(cuid())
  schemaId String
  number   Int
  name     String
  nameEn   String?
  maxScore Float
  criteria Criterion[]
  schema   AssessmentSchema @relation(fields: [schemaId], references: [id], onDelete: Cascade)

  @@unique([schemaId, number])
  @@map("skill_groups")
}

model SubCriterion {
  id       String           @id @default(cuid())
  moduleId String
  code     String
  name     String
  order    Int              @default(0)
  criteria Criterion[]
  module   AssessmentModule @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@map("sub_criteria")
}

model Criterion {
  id                 String        @id @default(cuid())
  subCriterionId     String
  skillGroupId       String?
  type               CriterionType
  description        String
  verificationMethod String?
  maxScore           Float
  judgementOptions   Json?
  order              Int           @default(0)
  skillGroup         SkillGroup?   @relation(fields: [skillGroupId], references: [id])
  subCriterion       SubCriterion  @relation(fields: [subCriterionId], references: [id], onDelete: Cascade)
  scores             Score[]

  @@map("criteria")
}

model Score {
  id          String    @id @default(cuid())
  criterionId String
  teamId      String
  expertId    String
  value       Float
  comment     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  criterion   Criterion @relation(fields: [criterionId], references: [id], onDelete: Cascade)
  expert      User      @relation(fields: [expertId], references: [id])
  team        Team      @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([criterionId, teamId])
  @@map("scores")
}

model ExpertAssignment {
  id         String   @id @default(cuid())
  expertId   String
  eventId    String
  moduleCode String?
  teamIds    String[]
  createdAt  DateTime @default(now())
  expert     User     @relation(fields: [expertId], references: [id], onDelete: Cascade)

  @@unique([expertId, eventId, moduleCode])
  @@map("expert_assignments")
}

model Protocol {
  id          String                @id @default(cuid())
  eventId     String
  title       String
  content     String              @db.Text
  version     Int                   @default(1)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  signatures  ProtocolSignature[]
  assignments ProtocolAssignment[]
  event       Event                 @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@map("protocols")
}

model ProtocolAssignment {
  id         String   @id @default(cuid())
  protocolId String
  userId     String
  createdAt  DateTime @default(now())
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([protocolId, userId])
  @@map("protocol_assignments")
}

model ProtocolSignature {
  id         String   @id @default(cuid())
  protocolId String
  userId     String
  signedAt   DateTime @default(now())
  ipAddress  String?
  protocol   Protocol @relation(fields: [protocolId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([protocolId, userId])
  @@map("protocol_signatures")
}

model SkillPassport {
  id               String    @id @default(cuid())
  userId           String
  eventId          String
  teamId           String?
  totalScore       Float
  moduleScores     Json
  skillGroupScores Json
  pdfUrl           String?
  publishedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  event            Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team             Team?     @relation(fields: [teamId], references: [id])
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, eventId])
  @@map("skill_passports")
}

enum UserRole {
  GUEST
  PARTICIPANT
  EXPERT
  ORGANIZER
  ADMIN
}

enum EventStatus {
  DRAFT
  REGISTRATION_OPEN
  REGISTRATION_CLOSED
  IN_PROGRESS
  SCORING
  RESULTS_PUBLISHED
  ARCHIVED
}

enum DocumentType {
  REGULATION
  SMP
  INFRASTRUCTURE
  SCHEDULE
  OTHER
}

enum DocumentAccess {
  PUBLIC
  PARTICIPANTS
  EXPERTS
  ORGANIZERS
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
  WITHDRAWN
}

enum TeamMemberRole {
  MEMBER
}

enum CriterionType {
  M
  J
}
